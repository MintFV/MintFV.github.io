<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="robots" content="noindex" />
  <title>MINT.FV Content Manager</title>
  <style>
    #quick-create-container {
      display: flex;
      gap: 8px;
      margin: 16px 0;
      flex-wrap: wrap;
      position: relative;
      z-index: 1;
    }

    .quick-btn {
      padding: 10px 16px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 600;
      transition: transform 0.1s, box-shadow 0.1s;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    .quick-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
    }
    .quick-btn.mach-mit-mathe { background: #009688; color: white; }
    .quick-btn.offene-werkstatt { background: #FF9800; color: white; }
    .quick-btn.ferienpass { background: #4CAF50; color: white; }
    .quick-btn.sonstige { background: #607D8B; color: white; }

    /* Color indicator bar - eigenes Element, bricht nichts */
    #event-type-indicator {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      z-index: 9999;
      pointer-events: none;
      transition: background-color 0.3s;
    }
  </style>
</head>
<body>
  <!-- Farbindikator - sicheres eigenes Element -->
  <div id="event-type-indicator"></div>

  <script src="https://unpkg.com/decap-cms@^3.0.0/dist/decap-cms.js"></script>

  <script>
      // ============================================
      // MINT.FV Decap CMS Customization
      // Version: 3.8.1 - Teal color for Mach mit Mathe
      // ============================================

    const EVENT_TYPE_DEFAULTS = {
      'mach-mit-mathe': {
        location: 'Ausstellungsraum',
        start_time: '14:00',
        end_time: '16:00',
        color: '#009688',  // Teal - passt zum ðŸ§® Abacus
        label: 'ðŸ§® Mach mit Mathe',
        optionMatch: 'Mach mit Mathe'
      },
      'offene-werkstatt': {
        location: 'Werkstatt',
        start_time: '16:00',
        end_time: '19:00',
        color: '#FF9800',  // Orange
        label: 'ðŸ”§ Offene Werkstatt',
        optionMatch: 'Offene Werkstatt'
      },
      'ferienpass': {
        location: 'VereinsrÃ¤ume',
        start_time: '11:00',
        end_time: '12:00',
        color: '#4CAF50',  // GrÃ¼n
        label: 'ðŸŽª Ferienpass',
        optionMatch: 'Ferienpass'
      },
      'sonstige': {
        location: '',
        start_time: '',
        end_time: '',
        color: '#607D8B',  // Grau
        label: 'ðŸ“… Sonstige',
        optionMatch: 'Sonstige'
      }
    };

      // ============================================
      // Helper: Setze React Input Wert
      // ============================================
      function setInputValue(input, value) {
        if (!input || !value) return false;

      input.focus();

      const nativeSetter = Object.getOwnPropertyDescriptor(
        window.HTMLInputElement.prototype, 'value'
      )?.set;

      if (nativeSetter) {
        nativeSetter.call(input, value);
      } else {
        input.value = value;
      }

      input.dispatchEvent(new Event('input', { bubbles: true }));
      input.dispatchEvent(new Event('change', { bubbles: true }));
      input.dispatchEvent(new Event('blur', { bubbles: true }));

      return true;
    }

      // ============================================
      // Helper: Erstelle datetime-local Wert
      // ============================================
      function createDateTimeLocalValue(timeString) {
        if (!timeString) return '';

      const now = new Date();
      const year = now.getFullYear();
      const month = String(now.getMonth() + 1).padStart(2, '0');
      const day = String(now.getDate()).padStart(2, '0');

      return `${year}-${month}-${day}T${timeString}`;
    }

      // ============================================
      // SICHERE Editor EinfÃ¤rbung - nur eigenes Element!
      // ============================================
      function colorizeEditor() {
        const hash = window.location.hash;
        const indicator = document.getElementById('event-type-indicator');

        if (!indicator) return;

        // Nur auf Editor-Seiten (new oder entries)
        if (!hash.includes('/collections/events/new') &&
          !hash.includes('/collections/events/entries/')) {
          indicator.style.backgroundColor = 'transparent';
          return;
        }

        const applyColor = () => {
          let eventType = null;

          // Versuche aus URL zu lesen (bei bestehenden EintrÃ¤gen)
          for (const type of Object.keys(EVENT_TYPE_DEFAULTS)) {
            if (hash.includes(type)) {
              eventType = type;
              break;
            }
          }

          // Oder aus dem Select-Widget lesen
          if (!eventType) {
            const selectValue = document.querySelector('[class*="singleValue"]');
            if (selectValue) {
              const text = selectValue.textContent || '';
              for (const [type, config] of Object.entries(EVENT_TYPE_DEFAULTS)) {
                if (text.includes(config.optionMatch)) {
                  eventType = type;
                  break;
                }
              }
            }
          }

          if (!eventType) {
            indicator.style.backgroundColor = 'transparent';
            return;
          }

          const config = EVENT_TYPE_DEFAULTS[eventType];
          if (!config) return;

          // Setze die Farbe nur auf unser eigenes Element
          indicator.style.backgroundColor = config.color;

          console.log(`ðŸŽ¨ Editor-Farbe: ${eventType} (${config.color})`);
        };

        // Initial und bei Ã„nderungen
        setTimeout(applyColor, 500);

        // Beobachte Ã„nderungen (z.B. wenn Dropdown geÃ¤ndert wird)
        const checkForChanges = () => {
          applyColor();
        };

        // Periodisch prÃ¼fen (sicherer als MutationObserver auf CMS-Elemente)
        const intervalId = setInterval(checkForChanges, 2000);

        // AufrÃ¤umen bei Navigation
        window.addEventListener('hashchange', () => {
          clearInterval(intervalId);
        }, { once: true });
      }

      // ============================================
      // Select Event Type
      // ============================================
      async function selectEventType(optionMatch) {
      try {
        const labels = document.querySelectorAll('label');
        let fieldContainer = null;

        for (const label of labels) {
          if (label.textContent.includes('Veranstaltungstyp')) {
            fieldContainer = label.closest('[class*="ControlContainer"]');
            break;
          }
        }

        if (!fieldContainer) return false;

        const indicator = fieldContainer.querySelector('[class*="indicatorContainer"]');

        if (indicator) {
          indicator.dispatchEvent(new MouseEvent('mousedown', {
            view: window,
            bubbles: true,
            cancelable: true
          }));
        } else {
          const control = fieldContainer.querySelector('[class*="control"]');
          if (control) {
            control.dispatchEvent(new MouseEvent('mousedown', { bubbles: true, cancelable: true }));
          }
        }

        await new Promise(resolve => setTimeout(resolve, 300));

        let options = document.querySelectorAll('[class*="option"]');

        if (options.length === 0) {
          const menu = document.querySelector('[class*="menu"]');
          if (menu) {
            options = menu.querySelectorAll('[class*="option"]');
          }
        }

        for (const option of options) {
          const text = option.textContent || '';

          if (text.includes(optionMatch)) {
            option.dispatchEvent(new MouseEvent('mousedown', { bubbles: true }));
            option.click();
            return true;
          }
        }

        return false;

      } catch (error) {
        console.error('âŒ Fehler:', error);
        return false;
      }
    }

      // ============================================
      // Defaults anwenden
      // ============================================
      async function applyDefaults(eventType) {
        const defaults = EVENT_TYPE_DEFAULTS[eventType];
        if (!defaults) return;

      await new Promise(resolve => setTimeout(resolve, 500));

      const inputs = document.querySelectorAll('input:not([type="hidden"])');

      let startSet = false;
      let endSet = false;

      inputs.forEach((input) => {
        const container = input.closest('[class*="Field"], [class*="Widget"]') || input.parentElement?.parentElement;
        const label = container?.querySelector('label');
        const labelText = label?.textContent?.toUpperCase() || '';

        if (input.type === 'datetime-local' && labelText.includes('STARTDATUM') && !startSet) {
          if (defaults.start_time && !input.value) {
            const dateTimeValue = createDateTimeLocalValue(defaults.start_time);
            setInputValue(input, dateTimeValue);
            startSet = true;
          }
        }

        if (input.type === 'datetime-local' && labelText.includes('ENDDATUM') && !endSet) {
          if (defaults.end_time && !input.value) {
            const dateTimeValue = createDateTimeLocalValue(defaults.end_time);
            setInputValue(input, dateTimeValue);
            endSet = true;
          }
        }
      });

      // FÃ¤rbe den Editor ein (sicher!)
      colorizeEditor();
    }

      // ============================================
      // 1. CMS Initialisierung
      // ============================================
      function initDecapCMS() {
        if (typeof CMS === 'undefined') {
          setTimeout(initDecapCMS, 100);
          return;
        }
        console.log('âœ… Decap CMS initialisiert');
        CMS.registerPreviewStyle('preview.css');
      }

      // ============================================
      // 2. Quick-Create Buttons
      // ============================================
      function addQuickCreateButtons() {
      const tryAddButtons = () => {
        const hash = window.location.hash;
        if (!hash.includes('/collections/events')) return;
        if (hash.includes('/new')) return;
        if (hash.includes('/entries/')) return;
        if (document.getElementById('quick-create-container')) return;

        const newButton = document.querySelector('a[href*="/new"]');
        if (!newButton) return;

        const headerArea = newButton.closest('div');
        if (!headerArea) return;

        const container = document.createElement('div');
        container.id = 'quick-create-container';

        Object.entries(EVENT_TYPE_DEFAULTS).forEach(([type, config]) => {
          const btn = document.createElement('button');
          btn.className = `quick-btn ${type}`;
          btn.textContent = `âž• ${config.label}`;
          btn.style.backgroundColor = config.color;

          btn.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            sessionStorage.setItem('preselectedEventType', type);
            console.log('ðŸŽ¯ Quick-Create:', type);
            window.location.hash = '#/collections/events/new';
          });

          container.appendChild(btn);
        });

        headerArea.parentNode.insertBefore(container, headerArea);
        console.log('âœ… Quick-Create Buttons hinzugefÃ¼gt');
      };

      const observer = new MutationObserver(tryAddButtons);
      observer.observe(document.body, { childList: true, subtree: true });

      window.addEventListener('hashchange', () => {
        document.getElementById('quick-create-container')?.remove();
        setTimeout(colorizeEditor, 500);
      });
    }

      // ============================================
      // 3. Farbcodierung Listen-Ansicht
      // ============================================
      function colorizeEventCards() {
      const style = document.createElement('style');
      style.id = 'event-colors';
      style.textContent = `
        a[href*="ferienpass"]::before { content:''; position:absolute; left:0; top:0; bottom:0; width:4px; background:#4CAF50; }
        a[href*="mach-mit-mathe"]::before { content:''; position:absolute; left:0; top:0; bottom:0; width:4px; background:#009688; }
        a[href*="offene-werkstatt"]::before { content:''; position:absolute; left:0; top:0; bottom:0; width:4px; background:#FF9800; }
        a[href*="-sonstige"]::before { content:''; position:absolute; left:0; top:0; bottom:0; width:4px; background:#607D8B; }
        li:has(a[href*="/events/entries/"]), div:has(> a[href*="/events/entries/"]):not([class*="App"]) { position:relative !important; }
      `;
      if (!document.getElementById('event-colors')) {
        document.head.appendChild(style);
      }
    }

      // ============================================
      // 4. Event Type Handler
      // ============================================
      function setupEventTypeHandler() {

      const handleNewPage = async () => {
        const preselected = sessionStorage.getItem('preselectedEventType');

        if (!preselected) {
          setTimeout(colorizeEditor, 1000);
          return;
        }

        console.log('ðŸŽ¯ Vorauswahl:', preselected);
        const defaults = EVENT_TYPE_DEFAULTS[preselected];

        if (!defaults) return;

        await new Promise(resolve => setTimeout(resolve, 1500));

        const success = await selectEventType(defaults.optionMatch);

        if (success) {
          console.log('âœ… Event-Type gesetzt!');
        }

        await new Promise(resolve => setTimeout(resolve, 500));
        await applyDefaults(preselected);

        sessionStorage.removeItem('preselectedEventType');
      };

      window.addEventListener('hashchange', () => {
        if (window.location.hash.includes('/collections/events/new')) {
          console.log('ðŸ“„ Neue Veranstaltung Seite');
          handleNewPage();
        } else if (window.location.hash.includes('/collections/events/entries/')) {
          setTimeout(colorizeEditor, 500);
        }
      });

      if (window.location.hash.includes('/collections/events/new')) {
        handleNewPage();
      } else if (window.location.hash.includes('/collections/events/entries/')) {
        setTimeout(colorizeEditor, 500);
      }
    }

      // ============================================
      // Init
      // ============================================
      const init = () => {
        initDecapCMS();
      addQuickCreateButtons();
      colorizeEventCards();
      setupEventTypeHandler();
    };

      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
      } else {
      init();
    }

      console.log('ðŸš€ MINT.FV CMS v3.8.1 geladen');
    </script>
  </body>
</html>
