<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="robots" content="noindex" />
  <title>MINT.FV Content Manager</title>
  <style>
    /*
       * Quick-Create Buttons - mit sicherer Positionierung
       * Wichtig: pointer-events: none auf Container, auto auf Buttons
       * um Klicks auf darunterliegende Elemente nicht zu blockieren
       */
    #quick-create-container {
      display: flex;
      gap: 8px;
      margin: 16px 0;
      flex-wrap: wrap;
      position: relative;
      z-index: 1;
      /* Niedrig halten! */
    }

    .quick-btn {
      padding: 10px 16px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 600;
      transition: transform 0.1s, box-shadow 0.1s;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    .quick-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
    }
    .quick-btn.mach-mit-mathe { background: #9C27B0; color: white; }
    .quick-btn.offene-werkstatt { background: #FF9800; color: white; }
    .quick-btn.ferienpass { background: #4CAF50; color: white; }
    .quick-btn.sonstige { background: #607D8B; color: white; }
  </style>
  </head>
<body>
  <!-- Decap CMS -->
  <script src="https://unpkg.com/decap-cms@^3.0.0/dist/decap-cms.js"></script>
  
  <script>
      // ============================================
      // MINT.FV Decap CMS Customization
      // Version: 3.0.0 - Clean implementation without layout issues
      // ============================================

    const EVENT_TYPE_DEFAULTS = {
      'mach-mit-mathe': {
        location: 'Ausstellungsraum',
        registration_required: false,
        registration_email: '',
        start_time: '14:00',
        end_time: '16:00',
        color: '#9C27B0',
        label: 'ðŸŽ¨ Mach mit Mathe'
      },
      'offene-werkstatt': {
        location: 'Werkstatt',
        registration_required: false,
        registration_email: '',
        start_time: '16:00',
        end_time: '19:00',
        color: '#FF9800',
        label: 'ðŸ”§ Offene Werkstatt'
      },
      'ferienpass': {
        location: 'VereinsrÃ¤ume',
        registration_required: true,
        registration_email: 'info@mintarium-fv.de',
        start_time: '11:00',
        end_time: '12:00',
        color: '#4CAF50',
        label: 'ðŸŽª Ferienpass'
      },
      'sonstige': {
        location: '',
        registration_required: false,
        registration_email: 'info@mintarium-fv.de',
        start_time: '',
        end_time: '',
        color: '#607D8B',
        label: 'ðŸ“… Sonstige'
      }
    };

      // ============================================
      // 1. CMS Initialisierung & Event Listener
      // ============================================
      function initDecapCMS() {
        if (typeof CMS === 'undefined') {
          console.warn('Decap CMS nicht geladen, warte...');
          setTimeout(initDecapCMS, 100);
          return;
        }

      console.log('âœ… Decap CMS 3.9.0 initialisiert');

      CMS.registerEventListener({
        name: 'preSave',
        handler: ({ entry }) => {
          console.log('ðŸ’¾ PreSave Hook fÃ¼r:', entry.getIn(['data', 'title']));
          const registrationRequired = entry.getIn(['data', 'registration_required']);
          const registrationEmail = entry.getIn(['data', 'registration_email']);
          if (registrationRequired && !registrationEmail) {
            console.warn('âš ï¸ Anmeldung erforderlich, aber keine Email angegeben');
          }
          return entry;
        }
      });

      CMS.registerEventListener({
        name: 'postSave',
        handler: ({ entry }) => {
          console.log('âœ… Event gespeichert:', entry.getIn(['data', 'title']));
        }
      });

      // Preview Styles - NUR fÃ¼r das Preview-Pane, nicht fÃ¼r Admin UI
      CMS.registerPreviewStyle('preview.css');

          console.log('âœ… Alle Event Listener registriert');
        }

        // ============================================
        // 2. Quick-Create Buttons - SICHER positioniert
        // ============================================
        function addQuickCreateButtons() {
          let containerAdded = false;

          const tryAddButtons = () => {
            // Nur auf der Events-Collection-Ãœbersicht
            const hash = window.location.hash;
            if (!hash.includes('/collections/events')) return;
            if (hash.includes('/new')) return;
            if (hash.includes('/entries/')) return;

            // PrÃ¼fe ob Container bereits existiert
            if (document.getElementById('quick-create-container')) return;

            // Finde den "Neue Veranstaltung" Button als Referenzpunkt
            const newButton = document.querySelector('a[href*="/new"], button[class*="TopNewButton"]');
            if (!newButton) return;

            // Finde den Ã¼bergeordneten Container
            const headerArea = newButton.closest('div');
            if (!headerArea) return;

            // Container erstellen
            const container = document.createElement('div');
            container.id = 'quick-create-container';

            Object.entries(EVENT_TYPE_DEFAULTS).forEach(([type, config]) => {
              const btn = document.createElement('button');
              btn.className = `quick-btn ${type}`;
              btn.textContent = `âž• ${config.label}`;
              btn.style.backgroundColor = config.color;

              btn.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                sessionStorage.setItem('preselectedEventType', type);
                window.location.hash = '#/collections/events/new';
              });

              container.appendChild(btn);
            });

            // FÃ¼ge Container VOR dem Header-Bereich ein (nicht darÃ¼ber!)
            headerArea.parentNode.insertBefore(container, headerArea);
            containerAdded = true;
            console.log('âœ… Quick-Create Buttons hinzugefÃ¼gt');
          };

          // MutationObserver mit Debouncing
          let debounceTimer;
          const observer = new MutationObserver(() => {
            if (containerAdded && document.getElementById('quick-create-container')) return;
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(tryAddButtons, 200);
          });

          observer.observe(document.body, { childList: true, subtree: true });

          // Bei Hash-Ã„nderung zurÃ¼cksetzen
          window.addEventListener('hashchange', () => {
            containerAdded = false;
            const existing = document.getElementById('quick-create-container');
            if (existing) existing.remove();
          });
        }

        // ============================================
        // 3. Farbcodierung - NUR Ã¼ber CSS-Klassen, KEINE DOM-Manipulation
        // ============================================
        function colorizeEventCards() {
          // Dynamisches Stylesheet erstellen
          const styleSheet = document.createElement('style');
          styleSheet.id = 'event-colorization-styles';
          styleSheet.textContent = `
        /* Farbcodierung fÃ¼r Event-Karten via CSS - keine DOM-Manipulation nÃ¶tig */
        /* Diese Selektoren nutzen :has() fÃ¼r moderne Browser */

        /* Listenansicht */
        a[href*="/collections/events/entries/"]:has(> *) {
          display: block;
          position: relative;
        }

        /* Ferienpass - GrÃ¼n */
        a[href*="ferienpass"]::before,
        li:has(a[href*="ferienpass"])::before,
        div:has(> a[href*="ferienpass"]):not([class*="App"])::before {
          content: '';
          position: absolute;
          left: 0;
          top: 0;
          bottom: 0;
          width: 4px;
          background-color: #4CAF50;
          border-radius: 2px 0 0 2px;
        }

        /* Mach mit Mathe - Lila */
        a[href*="mach-mit-mathe"]::before,
        li:has(a[href*="mach-mit-mathe"])::before,
        div:has(> a[href*="mach-mit-mathe"]):not([class*="App"])::before {
          content: '';
          position: absolute;
          left: 0;
          top: 0;
          bottom: 0;
          width: 4px;
          background-color: #9C27B0;
          border-radius: 2px 0 0 2px;
        }

        /* Offene Werkstatt - Orange */
        a[href*="offene-werkstatt"]::before,
        li:has(a[href*="offene-werkstatt"])::before,
        div:has(> a[href*="offene-werkstatt"]):not([class*="App"])::before {
          content: '';
          position: absolute;
          left: 0;
          top: 0;
          bottom: 0;
          width: 4px;
          background-color: #FF9800;
          border-radius: 2px 0 0 2px;
        }

        /* Sonstige - Grau */
        a[href*="-sonstige"]::before,
        li:has(a[href*="-sonstige"])::before,
        div:has(> a[href*="-sonstige"]):not([class*="App"])::before {
          content: '';
          position: absolute;
          left: 0;
          top: 0;
          bottom: 0;
          width: 4px;
          background-color: #607D8B;
          border-radius: 2px 0 0 2px;
        }

        /* Positionierung fÃ¼r Parent-Elemente */
        li:has(a[href*="/collections/events/entries/"]),
        div:has(> a[href*="/collections/events/entries/"]):not([class*="App"]):not([class*="Container"]) {
          position: relative !important;
        }
      `;

      // Nur einmal hinzufÃ¼gen
      if (!document.getElementById('event-colorization-styles')) {
        document.head.appendChild(styleSheet);
        console.log('âœ… Event-Farbcodierung CSS hinzugefÃ¼gt');
      }
    }

      // ============================================
      // 4. Event Type Handler (Defaults setzen)
      // ============================================
      function setupEventTypeHandler() {
        let isHandlerAttached = false;

        const applyDefaults = (selectedType, force = false) => {
          const defaults = EVENT_TYPE_DEFAULTS[selectedType];
        if (!defaults) {
          console.log('âŒ Keine Defaults fÃ¼r:', selectedType);
          return;
        }

        console.log('ðŸ”§ Setze Defaults fÃ¼r:', selectedType);

        setTimeout(() => {
          // Location
          const locationInput = document.querySelector('input[name="location"]');
          if (locationInput && (force || !locationInput.value)) {
            locationInput.value = defaults.location;
            locationInput.dispatchEvent(new Event('input', { bubbles: true }));
            locationInput.dispatchEvent(new Event('change', { bubbles: true }));
          }

          // Registration Required
          const regCheckbox = document.querySelector('input[type="checkbox"][id*="registration"], input[name="registration_required"]');
          if (regCheckbox) {
            regCheckbox.checked = defaults.registration_required;
            regCheckbox.dispatchEvent(new Event('change', { bubbles: true }));
          }

          // Registration Email
          const regEmailInput = document.querySelector('input[name="registration_email"]');
          if (regEmailInput && (force || !regEmailInput.value)) {
            regEmailInput.value = defaults.registration_email;
            regEmailInput.dispatchEvent(new Event('input', { bubbles: true }));
          }

          // Start Time
          const startTimeInput = document.querySelector('input[name="start_date.time"]');
          if (startTimeInput && defaults.start_time && (force || !startTimeInput.value)) {
            startTimeInput.value = defaults.start_time;
            startTimeInput.dispatchEvent(new Event('input', { bubbles: true }));
            startTimeInput.dispatchEvent(new Event('change', { bubbles: true }));
            console.log('â° Start-Zeit gesetzt:', defaults.start_time);
          }

          // End Time
          const endTimeInput = document.querySelector('input[name="end_date.time"]');
          if (endTimeInput && defaults.end_time && (force || !endTimeInput.value)) {
            endTimeInput.value = defaults.end_time;
            endTimeInput.dispatchEvent(new Event('input', { bubbles: true }));
            endTimeInput.dispatchEvent(new Event('change', { bubbles: true }));
            console.log('â° End-Zeit gesetzt:', defaults.end_time);
          }

          console.log('âœ… Defaults erfolgreich gesetzt');
        }, 300);
      };

      const attachHandler = () => {
        const eventTypeSelect = document.querySelector('select[name="event_type"]');

        if (eventTypeSelect && !isHandlerAttached) {
          console.log('ðŸ”— Event Type Handler eingerichtet');
          isHandlerAttached = true;

          // Check fÃ¼r vorgewÃ¤hlten Typ aus Quick-Create
          const preselected = sessionStorage.getItem('preselectedEventType');
          if (preselected) {
            console.log('ðŸŽ¯ VorgewÃ¤hlter Typ:', preselected);
            setTimeout(() => {
              eventTypeSelect.value = preselected;
              eventTypeSelect.dispatchEvent(new Event('change', { bubbles: true }));
              applyDefaults(preselected, true);
              sessionStorage.removeItem('preselectedEventType');
            }, 500);
          }

          eventTypeSelect.addEventListener('change', (e) => {
            applyDefaults(e.target.value, false);
          });
        }
      };

      const observer = new MutationObserver(attachHandler);
      observer.observe(document.body, { childList: true, subtree: true });
      attachHandler();
      }

      // ============================================
      // 5. Cleanup bei Navigation
      // ============================================
      function setupNavigationHandler() {
        window.addEventListener('hashchange', () => {
          const hash = window.location.hash;

        // Reset Event Type Handler wenn wir die /new Seite verlassen
        if (!hash.includes('/new')) {
          // Handler wird beim nÃ¤chsten Mal neu attached
        }
      });
    }

      // ============================================
      // Initialisierung
      // ============================================
      const init = () => {
        initDecapCMS();
        setupEventTypeHandler();
          addQuickCreateButtons();
          colorizeEventCards();
          setupNavigationHandler();
        };

        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', init);
        } else {
      init();
    }

  console.log('ðŸš€ MINT.FV CMS Customization v3.0.0 geladen');
</script>
  </body>
</html>
