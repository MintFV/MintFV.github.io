<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="robots" content="noindex" />
  <title>MINT.FV Content Manager</title>
  <style>
    #quick-create-container {
      display: flex;
      gap: 8px;
      margin: 16px 0;
      flex-wrap: wrap;
      position: relative;
      z-index: 1;
    }

    .quick-btn {
      padding: 10px 16px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 600;
      transition: transform 0.1s, box-shadow 0.1s;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    .quick-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
    }
    .quick-btn.mach-mit-mathe { background: #9C27B0; color: white; }
    .quick-btn.offene-werkstatt { background: #FF9800; color: white; }
    .quick-btn.ferienpass { background: #4CAF50; color: white; }
    .quick-btn.sonstige { background: #607D8B; color: white; }
  </style>
</head>
<body>
  <script src="https://unpkg.com/decap-cms@^3.0.0/dist/decap-cms.js"></script>

  <script>
      // ============================================
      // MINT.FV Decap CMS Customization
      // Version: 3.6.0 - Fixed datetime-local inputs
      // ============================================

    const EVENT_TYPE_DEFAULTS = {
      'mach-mit-mathe': {
        location: 'Ausstellungsraum',
        start_time: '14:00',
        end_time: '16:00',
        color: '#9C27B0',
        label: 'ðŸŽ¨ Mach mit Mathe',
        optionMatch: 'Mach mit Mathe'
      },
      'offene-werkstatt': {
        location: 'Werkstatt',
        start_time: '16:00',
        end_time: '19:00',
        color: '#FF9800',
        label: 'ðŸ”§ Offene Werkstatt',
        optionMatch: 'Offene Werkstatt'
      },
      'ferienpass': {
        location: 'VereinsrÃ¤ume',
        start_time: '11:00',
        end_time: '12:00',
        color: '#4CAF50',
        label: 'ðŸŽª Ferienpass',
        optionMatch: 'Ferienpass'
      },
      'sonstige': {
        location: '',
        start_time: '',
        end_time: '',
        color: '#607D8B',
        label: 'ðŸ“… Sonstige',
        optionMatch: 'Sonstige'
      }
    };

      // ============================================
      // Helper: Setze React Input Wert
      // ============================================
      function setInputValue(input, value) {
        if (!input || !value) return false;

        input.focus();

        // Native setter fÃ¼r React
        const nativeSetter = Object.getOwnPropertyDescriptor(
          window.HTMLInputElement.prototype, 'value'
        )?.set;

        if (nativeSetter) {
          nativeSetter.call(input, value);
        } else {
          input.value = value;
        }

      // Events fÃ¼r React
      input.dispatchEvent(new Event('input', { bubbles: true }));
      input.dispatchEvent(new Event('change', { bubbles: true }));
      input.dispatchEvent(new Event('blur', { bubbles: true }));

      console.log(`ðŸ“ Input gesetzt: "${value}"`);
      return true;
    }

  // ============================================
  // Helper: Erstelle datetime-local Wert
  // Format: YYYY-MM-DDTHH:mm
  // ============================================
  function createDateTimeLocalValue(timeString) {
    if (!timeString) return '';

    const now = new Date();
    const year = now.getFullYear();
    const month = String(now.getMonth() + 1).padStart(2, '0');
    const day = String(now.getDate()).padStart(2, '0');

    // Format: 2025-12-07T14:00
    return `${year}-${month}-${day}T${timeString}`;
  }

      // ============================================
      // CORE: Select Option in react-select
      // ============================================
      async function selectEventType(optionMatch) {
        console.log(`ðŸŽ¯ Versuche "${optionMatch}" auszuwÃ¤hlen...`);

        try {
          // 1. Finde das Veranstaltungstyp-Feld
          const labels = document.querySelectorAll('label');
          let fieldContainer = null;

          for (const label of labels) {
            if (label.textContent.includes('Veranstaltungstyp')) {
              fieldContainer = label.closest('[class*="ControlContainer"]');
              break;
            }
          }

          if (!fieldContainer) {
            console.log('âŒ ControlContainer nicht gefunden');
            return false;
          }

          console.log('âœ… ControlContainer gefunden');

          // 2. Finde den Dropdown-Indicator
          const indicator = fieldContainer.querySelector('[class*="indicatorContainer"]');

          if (indicator) {
            console.log('âœ… Indicator gefunden, klicke...');
            indicator.dispatchEvent(new MouseEvent('mousedown', {
              view: window,
              bubbles: true,
              cancelable: true
            }));
          } else {
            // Fallback: control
            const control = fieldContainer.querySelector('[class*="control"]');
            if (control) {
              control.dispatchEvent(new MouseEvent('mousedown', { bubbles: true, cancelable: true }));
            }
          }

          // 3. Warte auf das Dropdown-MenÃ¼
          await new Promise(resolve => setTimeout(resolve, 300));

          // 4. Suche nach den Optionen
          let options = document.querySelectorAll('[class*="option"]');

          if (options.length === 0) {
            const menu = document.querySelector('[class*="menu"]');
            if (menu) {
              options = menu.querySelectorAll('[class*="option"]');
            }
          }

          console.log(`ðŸ“‹ Gefundene Optionen: ${options.length}`);

          // 5. Finde und klicke auf die richtige Option
          for (const option of options) {
            const text = option.textContent || '';

            if (text.includes(optionMatch)) {
              console.log(`âœ… Klicke auf: "${text}"`);
              option.dispatchEvent(new MouseEvent('mousedown', { bubbles: true }));
              option.click();
              return true;
            }
          }

          console.log(`âš ï¸ Option "${optionMatch}" nicht gefunden`);
          return false;

        } catch (error) {
          console.error('âŒ Fehler:', error);
          return false;
        }
      }

      // ============================================
      // Defaults anwenden - FIXED fÃ¼r datetime-local
      // ============================================
      async function applyDefaults(eventType) {
        const defaults = EVENT_TYPE_DEFAULTS[eventType];
        if (!defaults) return;

        console.log(`ðŸ”§ Wende Defaults an fÃ¼r: ${eventType}`);

        // Warte etwas
        await new Promise(resolve => setTimeout(resolve, 500));

        // Finde alle Inputs
        const inputs = document.querySelectorAll('input:not([type="hidden"])');
        console.log(`ðŸ“‹ Gefundene Inputs: ${inputs.length}`);

        let startSet = false;
        let endSet = false;

        inputs.forEach((input, i) => {
          // Finde das zugehÃ¶rige Label
          const container = input.closest('[class*="Field"], [class*="Widget"]') || input.parentElement?.parentElement;
          const label = container?.querySelector('label');
          const labelText = label?.textContent?.toUpperCase() || '';

          // DEBUG: Zeige alle datetime-local Inputs
          if (input.type === 'datetime-local') {
            console.log(`  â° datetime-local Input: Label="${labelText.substring(0, 30)}", value="${input.value}"`);
          }

          // STARTDATUM UND UHRZEIT
          if (input.type === 'datetime-local' && labelText.includes('STARTDATUM') && !startSet) {
            if (defaults.start_time && !input.value) {
              const dateTimeValue = createDateTimeLocalValue(defaults.start_time);
              console.log(`â° Setze Startzeit: ${dateTimeValue}`);
              setInputValue(input, dateTimeValue);
              startSet = true;
            }
          }

          // ENDDATUM UND UHRZEIT
          if (input.type === 'datetime-local' && labelText.includes('ENDDATUM') && !endSet) {
            if (defaults.end_time && !input.value) {
              const dateTimeValue = createDateTimeLocalValue(defaults.end_time);
              console.log(`â° Setze Endzeit: ${dateTimeValue}`);
              setInputValue(input, dateTimeValue);
              endSet = true;
            }
        }
      });

      if (startSet || endSet) {
        console.log('âœ… Zeiten gesetzt!');
      } else {
        console.log('âš ï¸ Keine Zeiten gesetzt - evtl. schon Werte vorhanden oder Inputs nicht gefunden');
      }

      console.log('âœ… Defaults angewendet');
    }

      // ============================================
      // 1. CMS Initialisierung
      // ============================================
      function initDecapCMS() {
        if (typeof CMS === 'undefined') {
          setTimeout(initDecapCMS, 100);
          return;
        }
        console.log('âœ… Decap CMS initialisiert');
        CMS.registerPreviewStyle('preview.css');
      }

      // ============================================
      // 2. Quick-Create Buttons
      // ============================================
      function addQuickCreateButtons() {
      const tryAddButtons = () => {
        const hash = window.location.hash;
        if (!hash.includes('/collections/events')) return;
        if (hash.includes('/new')) return;
        if (hash.includes('/entries/')) return;
        if (document.getElementById('quick-create-container')) return;

        const newButton = document.querySelector('a[href*="/new"]');
        if (!newButton) return;

        const headerArea = newButton.closest('div');
        if (!headerArea) return;

        const container = document.createElement('div');
        container.id = 'quick-create-container';

        Object.entries(EVENT_TYPE_DEFAULTS).forEach(([type, config]) => {
          const btn = document.createElement('button');
          btn.className = `quick-btn ${type}`;
          btn.textContent = `âž• ${config.label}`;
          btn.style.backgroundColor = config.color;

          btn.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            sessionStorage.setItem('preselectedEventType', type);
            console.log('ðŸŽ¯ Quick-Create:', type);
            window.location.hash = '#/collections/events/new';
          });

          container.appendChild(btn);
        });

        headerArea.parentNode.insertBefore(container, headerArea);
        console.log('âœ… Quick-Create Buttons hinzugefÃ¼gt');
      };

      const observer = new MutationObserver(tryAddButtons);
      observer.observe(document.body, { childList: true, subtree: true });

      window.addEventListener('hashchange', () => {
        document.getElementById('quick-create-container')?.remove();
      });
    }

      // ============================================
      // 3. Farbcodierung
      // ============================================
      function colorizeEventCards() {
      const style = document.createElement('style');
      style.id = 'event-colors';
      style.textContent = `
        a[href*="ferienpass"]::before { content:''; position:absolute; left:0; top:0; bottom:0; width:4px; background:#4CAF50; }
        a[href*="mach-mit-mathe"]::before { content:''; position:absolute; left:0; top:0; bottom:0; width:4px; background:#9C27B0; }
        a[href*="offene-werkstatt"]::before { content:''; position:absolute; left:0; top:0; bottom:0; width:4px; background:#FF9800; }
        a[href*="-sonstige"]::before { content:''; position:absolute; left:0; top:0; bottom:0; width:4px; background:#607D8B; }
        li:has(a[href*="/events/entries/"]), div:has(> a[href*="/events/entries/"]):not([class*="App"]) { position:relative !important; }
      `;
      if (!document.getElementById('event-colors')) {
        document.head.appendChild(style);
      }
    }

      // ============================================
      // 4. Event Type Handler - Hauptlogik
      // ============================================
      function setupEventTypeHandler() {

      const handleNewPage = async () => {
        const preselected = sessionStorage.getItem('preselectedEventType');

        if (!preselected) {
          console.log('â„¹ï¸ Keine Vorauswahl');
          return;
        }

        console.log('ðŸŽ¯ Vorauswahl:', preselected);
        const defaults = EVENT_TYPE_DEFAULTS[preselected];

        if (!defaults) {
          console.log('âŒ Keine Defaults gefunden');
          return;
        }

        // Warte bis die Seite geladen ist
        await new Promise(resolve => setTimeout(resolve, 2000));

        // WÃ¤hle den Event-Type
        const success = await selectEventType(defaults.optionMatch);

        if (success) {
          console.log('âœ… Event-Type gesetzt!');
        }

        // Warte und wende Defaults an (auch wenn Select nicht geklappt hat)
        await new Promise(resolve => setTimeout(resolve, 500));
        await applyDefaults(preselected);

        // LÃ¶sche die Vorauswahl
        sessionStorage.removeItem('preselectedEventType');
      };

      window.addEventListener('hashchange', () => {
        if (window.location.hash.includes('/collections/events/new')) {
          console.log('ðŸ“„ Neue Veranstaltung Seite');
          handleNewPage();
        }
      });

      if (window.location.hash.includes('/collections/events/new')) {
        handleNewPage();
      }
    }

      // ============================================
      // Init
      // ============================================
      const init = () => {
        initDecapCMS();
      addQuickCreateButtons();
      colorizeEventCards();
      setupEventTypeHandler();
    };

      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
      } else {
      init();
    }

      console.log('ðŸš€ MINT.FV CMS v3.6.0 geladen');
    </script>
  </body>
</html>
